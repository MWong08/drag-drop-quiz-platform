<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Game - Drag & Drop Quiz</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Lobby Screen */
        .lobby-screen {
            text-align: center;
        }

        .lobby-screen h1 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .game-code-display {
            background: white;
            color: #667eea;
            padding: 40px;
            border-radius: 20px;
            font-size: 4em;
            font-weight: bold;
            letter-spacing: 10px;
            margin: 30px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .join-instructions {
            font-size: 1.3em;
            margin-bottom: 40px;
        }

        .participants-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .participants-section h2 {
            margin-bottom: 20px;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .participant-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
        }

        .btn {
            padding: 20px 40px;
            font-size: 1.3em;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            background: #999;
            cursor: not-allowed;
        }

        /* Game Screen */
        .game-screen {
            display: none;
            text-align: center;
        }

        .game-screen h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .game-info h2 {
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Results Screen */
        .results-screen {
            display: none;
            text-align: center;
        }

        .leaderboard {
            background: white;
            color: #333;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .leaderboard h2 {
            color: #667eea;
            margin-bottom: 30px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: #f5f5f5;
            border-radius: 15px;
            font-size: 1.2em;
        }

        .leaderboard-item.first {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            font-size: 1.4em;
        }

        .leaderboard-item.second {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        }

        .leaderboard-item.third {
            background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%);
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
        }

        .btn-end {
            margin-top: 30px;
            background: #f44336;
        }

        .btn-end:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="lobby-screen">
            <h1>üéÆ Game Lobby</h1>
            <div class="game-code-display" id="game-code-display">XXXXXX</div>
            <p class="join-instructions">
                Players can join using this code at: <strong>{{ request.host_url }}game/join</strong>
            </p>

            <div class="participants-section">
                <h2>Waiting for Players...</h2>
                <div class="participants-grid" id="participants-list">
                    <div class="participant-card" style="opacity: 0.5;">Waiting for players...</div>
                </div>
                <p id="participant-count">0 players joined</p>
            </div>

            <button class="btn" id="start-btn" onclick="startGame()" disabled>
                Start Game
            </button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <h1>üéÆ Game in Progress</h1>
            
            <div class="game-info">
                <h2 id="quiz-title">Quiz Title</h2>
                <p>Players are arranging items...</p>
                
                <div class="stats">
                    <div class="stat-card">
                        <div>Players</div>
                        <div class="stat-number" id="total-players">0</div>
                    </div>
                    <div class="stat-card">
                        <div>Completed</div>
                        <div class="stat-number" id="completed-count">0</div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="showResults()">
                View Results
            </button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="results-screen">
            <h1>üèÜ Final Results</h1>
            
            <div class="leaderboard">
                <h2>Leaderboard</h2>
                <div id="leaderboard-list">
                    <!-- Leaderboard items will be added dynamically -->
                </div>
            </div>

            <button class="btn btn-end" onclick="endGame()">
                End Game & Return to Dashboard
            </button>
        </div>
    </div>

    <script>
        const socket = io();
        const gameCode = "{{ game_code }}";
        let participants = [];
        let completedCount = 0;

        // Join host room
        socket.emit('join_host_room', { game_code: gameCode });

        document.getElementById('game-code-display').textContent = gameCode;

        // Listen for participants joining
        socket.on('participant_joined', (data) => {
            // Prevent duplicate participants by checking if already exists
            const exists = participants.some(p => p.participant_id === data.participant_id);
            if (!exists) {
                participants.push(data);
                updateParticipantsList();
                
                const startBtn = document.getElementById('start-btn');
                startBtn.disabled = participants.length === 0;
                if (participants.length > 0) {
                    startBtn.textContent = `Start Game (${participants.length} player${participants.length > 1 ? 's' : ''})`;
                }
            }
        });

        function updateParticipantsList() {
            const participantsList = document.getElementById('participants-list');
            const participantCount = document.getElementById('participant-count');
            
            if (participants.length === 0) {
                participantsList.innerHTML = '<div class="participant-card" style="opacity: 0.5;">Waiting for players...</div>';
            } else {
                participantsList.innerHTML = participants.map(p => `
                    <div class="participant-card">
                        üë§ ${p.nickname}
                    </div>
                `).join('');
            }
            
            participantCount.textContent = `${participants.length} player${participants.length !== 1 ? 's' : ''} joined`;
        }

        function startGame() {
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';

            // Emit start game event
            socket.emit('start_game', { game_code: gameCode });

            // Show game screen
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';

            document.getElementById('total-players').textContent = participants.length;
        }

        socket.on('game_started', (data) => {
            document.getElementById('quiz-title').textContent = data.quiz.title;
        });

        // Listen for answer submissions
        socket.on('answer_result', () => {
            completedCount++;
            document.getElementById('completed-count').textContent = completedCount;
        });

        function showResults() {
            socket.emit('get_results', { game_code: gameCode });
            
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
        }

        socket.on('results_ready', (data) => {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';

            if (data.leaderboard.length === 0) {
                leaderboardList.innerHTML = '<p style="text-align: center; color: #999;">No results yet</p>';
                return;
            }

            data.leaderboard.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                if (index === 0) item.classList.add('first');
                else if (index === 1) item.classList.add('second');
                else if (index === 2) item.classList.add('third');
                
                let medal = '';
                if (index === 0) medal = 'ü•á ';
                else if (index === 1) medal = 'ü•à ';
                else if (index === 2) medal = 'ü•â ';
                
                item.innerHTML = `
                    <div>
                        <span class="rank">${medal}${player.rank}.</span>
                        <span>${player.nickname}</span>
                    </div>
                    <div><strong>${player.score}</strong> points</div>
                `;
                
                leaderboardList.appendChild(item);
            });
        });

        function endGame() {
            socket.emit('end_game', { game_code: gameCode });
            alert('Game ended! Returning to dashboard...');
            window.location.href = '/admin/dashboard';
        }
    </script>
</body>
</html>
